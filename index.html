<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server and Tree Carbon Calculator</title>
    <link rel="stylesheet" href="https://use.typekit.net/vhy8inj.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="static/styles.css">
</head>
<body>
    <div class="total-offset">
        <h2>Total carbon offset: <span>{{ total_carbon_offset }}</span> kg CO2</h2>
    </div>

    <div class="calculator">
        <div class="display">
            <h1>Server</h1>
            <div class="calculations">
                <div>Total CO2-eq emmissions: <span id="carbon-output">Loading...</span> kg</div>
                <div class="measurements">
                    <div>Current electrical usage: <span id="current-watts">Loading...</span> W</div>
                    <div>Total electricity used: <span id="total-kwh">Loading...</span> kWh</div>
                    <div>Time running: <span id="uptime">Loading...</span></div>
                </div>
            </div>
            <!-- <p><i>*Notes on calculation</i></p> -->
        </div>
        <div class="display">
            <h1>Tree (Paulownia tomentosa)</h1>
            <div class="calculations">
                <div>CO2 captured (kg): {{ tree_stats['CO2 Captured (Kg)'] }}</div>
            </div>
            <div class="measurements">
                <div>Diameter (cm): {{ tree_stats['Diameter (cm)'] }}</div>
                <div>Height (m): {{ tree_stats['Height (m)'] }}</div>
                <div>Dry biomass (kg): {{ tree_stats['Dry Biomass (Kg)'] }}</div>
            </div>

            <!-- <p><i>*Notes on calculation</i></p> -->
        </div>
    </div>

    <div class="archive">
        {% for record in records %}
        <div class="archive-item">
            <p>{{ record['datetime'] }}</p>
            <img src="data:image/jpeg;base64,{{ record['image'] }}" alt="Record Image">
            <p>Height: {{ record['height'] }} cm</p>
            <p>Width: {{ record['width'] }} cm</p>
        </div>
        {% endfor %}
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const socket = new WebSocket("ws://tendergarden.io/ws/carbon-footprint");

            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                document.getElementById("current-watts").textContent = data.current_watts.toFixed(2);
                document.getElementById("total-kwh").textContent = data.total_kwh.toFixed(6);
                document.getElementById("carbon-output").textContent = data.total_co2_emissions.toFixed(6);

                // Convert uptime from seconds to hh:mm:ss
                let uptime = parseInt(data.uptime_seconds);
                let hours = Math.floor(uptime / 3600);
                let minutes = Math.floor((uptime % 3600) / 60);
                let seconds = uptime % 60;
                document.getElementById("uptime").textContent = 
                    hours.toString().padStart(2, '0') + ':' + 
                    minutes.toString().padStart(2, '0') + ':' + 
                    seconds.toString().padStart(2, '0');
            };

            socket.onclose = function(event) {
                console.log("WebSocket closed:", event);
            };

            socket.onerror = function(error) {
                console.log("WebSocket error:", error);
            };
        });
    </script>
</body>
</html>
